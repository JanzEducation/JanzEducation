<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard | Janz Education</title>
    
    <link href='https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800&family=Noto+Sans+Devanagari:wght@400;700&display=swap' rel='stylesheet'/>
    <script src='https://cdn.tailwindcss.com'></script>

    <style>
        /* üé® DESIGN - Bilkul Wahi Structure Jo Apne Diya */
        body { font-family: 'Poppins', 'Noto Sans Devanagari', sans-serif; background: #f0f4f8; margin: 0; padding: 0; display: flex; flex-direction: column; min-height: 100vh; }
        .main-wrapper { flex: 1; }

        header { 
            background: linear-gradient(135deg, #0f172a 0%, #1e3a8a 100%); 
            color: #fff; padding: 15px 5%; text-align: center; 
            border-bottom: 4px solid #fbbf24; border-radius: 0 0 25px 25px; 
            box-shadow: 0 5px 20px rgba(0,0,0,0.2); 
            position: relative;
        }
        header h1 { font-size: 24px; font-weight: 800; color: #fbbf24; margin: 0; }
        header p { font-size: 12px; opacity: 0.9; margin-top: 4px; color: #f8fafc; }

        .main-container { max-width: 800px; margin: 30px auto; padding: 0 20px; }

        .welcome-box { background: white; padding: 20px; border-radius: 15px; border-left: 5px solid #2563eb; box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 25px; }
        
        /* üìÅ Folder Card Design */
        .folder-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; }
        .folder-card { 
            background: white; padding: 25px 15px; border-radius: 15px; border: 1px solid #e2e8f0; 
            text-align: center; cursor: pointer; transition: 0.3s;
        }
        .folder-card:hover { transform: translateY(-5px); border-color: #fbbf24; background: #fffbeb; }
        .folder-icon { font-size: 40px; margin-bottom: 10px; display: block; }

        /* üìù Test Card Style (Same as your structure) */
        .test-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px; }
        .test-card { 
            background: white; padding: 15px; border-radius: 12px; border: 1px solid #e2e8f0; 
            transition: transform 0.2s; position: relative;
        }
        .test-card:hover { transform: translateY(-3px); border-color: #fbbf24; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
        
        .logout-btn { background: #fee2e2; color: #991b1b; padding: 5px 12px; border-radius: 20px; font-size: 12px; font-weight: bold; cursor: pointer; border: none; float: right; transition: 0.2s;}
        .logout-btn:hover { background: #fecaca; }

        #loading-screen { position: fixed; inset: 0; background: white; z-index: 100; display: flex; justify-content: center; align-items: center; }
        
        footer { text-align: center; padding: 40px 20px; background: #fff; border-top: 2px solid #e2e8f0; margin-top: auto; }
        .about-box { background: #f8fafc; padding: 20px; border-radius: 15px; border: 1px dashed #cbd5e1; margin-bottom: 20px; }
    </style>
</head>
<body>

    <div id="loading-screen">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-900"></div>
    </div>

    <div class='main-wrapper'>
        <header>
            <h1>JANZ EDUCATION</h1>
            <p>‡§∏‡§™‡§®‡•ã‡§Ç ‡§ï‡•Ä ‡§â‡•ú‡§æ‡§®, ‡§∂‡§ø‡§ï‡•ç‡§∑‡§æ ‡§ï‡•á ‡§∏‡§æ‡§• üöÄ</p>
        </header>

        <div class='main-container'>
            
            <div class="welcome-box">
                <button id="logout-btn" class="logout-btn">Logout</button>
                <h2 class="text-xl font-bold text-gray-800">Hello, <span id="user-name">Student</span> üëã</h2>
                <div class="flex items-center gap-2 mt-1">
                    <button id="back-btn" class="hidden text-blue-600 font-bold text-xs bg-blue-50 px-2 py-1 rounded">‚¨ÖÔ∏è Back</button>
                    <p class="text-sm text-gray-500" id="path-text">Test Series 2026</p>
                </div>
            </div>

            <h3 class="font-bold text-gray-700 mb-4 border-l-4 border-yellow-400 pl-3" id="title-text">All Exams</h3>

            <div id="content-area" class="folder-grid">
                </div>

            <div id="no-data-msg" class="hidden text-center py-10 bg-white rounded-xl border border-dashed border-gray-300">
                <p class="text-gray-400 text-sm">‡§Ö‡§≠‡•Ä ‡§Ø‡§π‡§æ‡§Å ‡§ï‡•Å‡§õ ‡§≠‡•Ä ‡§â‡§™‡§≤‡§¨‡•ç‡§ß ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à‡•§</p>
            </div>

        </div>
    </div>

    <footer>
        <div class='about-box' style='max-width:560px; margin:0 auto;'>
            <h4 style='color:#0f172a; font-weight:bold; margin-bottom:10px;'>ABOUT US</h4>
            <p style='font-size:13px; color:#475569; line-height:1.6;'>‡§Ø‡§π ‡§™‡•ç‡§≤‡•á‡§ü‡§´‡§æ‡§∞‡•ç‡§Æ <b>Janz Group</b> ‡§¶‡•ç‡§µ‡§æ‡§∞‡§æ ‡§µ‡§ø‡§¶‡•ç‡§Ø‡§æ‡§∞‡•ç‡§•‡§ø‡§Ø‡•ã‡§Ç ‡§ï‡•ã ‡§ë‡§®‡§≤‡§æ‡§á‡§® ‡§™‡•ç‡§∞‡•à‡§ï‡•ç‡§ü‡§ø‡§∏ ‡§ï‡•Ä ‡§∏‡•Å‡§µ‡§ø‡§ß‡§æ ‡§™‡•ç‡§∞‡§¶‡§æ‡§® ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§∏‡§Æ‡§∞‡•ç‡§™‡§ø‡§§ ‡§π‡•à‡•§</p>
        </div>
        <p style='font-size: 12px; color: #64748b;'>¬©2026 Janz Education ‡§∏‡§Ç‡§ö‡§æ‡§≤‡§ø‡§§ By Janz Group</p>
    </footer>

    <script type="module">
        import { auth, db } from "./config.js";
        import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { collection, getDocs, query, where } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const loader = document.getElementById('loading-screen');
        const contentArea = document.getElementById('content-area');
        const pathText = document.getElementById('path-text');
        const titleText = document.getElementById('title-text');
        const backBtn = document.getElementById('back-btn');

        let allTests = [];
        let viewState = { level: 'exam', exam: '', subject: '' };
        let userResults = new Set();
        const ADMIN_EMAIL = "mdayubjanz@gmail.com";

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                if(user.email === ADMIN_EMAIL) { window.location.href = "admin.html"; return; }
                document.getElementById('user-name').innerText = user.displayName || "Student";
                
                // 1. User ke results fetch karo (Attempt/Re-attempt ke liye)
                const resSnap = await getDocs(query(collection(db, "results"), where("userId", "==", user.uid)));
                resSnap.forEach(doc => userResults.add(doc.data().testId));

                // 2. Sare tests load karo
                const testSnap = await getDocs(collection(db, "tests"));
                allTests = testSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                renderUI();
                loader.style.display = 'none';
            } else {
                window.location.href = "index.html";
            }
        });

        function renderUI() {
            contentArea.innerHTML = "";
            document.getElementById('no-data-msg').classList.add('hidden');

            if (viewState.level === 'exam') {
                contentArea.className = "folder-grid";
                pathText.innerText = "Test Series 2026";
                titleText.innerText = "Select Exam Folder";
                backBtn.classList.add('hidden');

                const exams = [...new Set(allTests.map(t => t.exam))];
                if(exams.length === 0) document.getElementById('no-data-msg').classList.remove('hidden');
                exams.forEach(ex => createFolder(ex, "üìÇ", () => {
                    viewState.level = 'subject'; viewState.exam = ex; renderUI();
                }));
            } 
            else if (viewState.level === 'subject') {
                contentArea.className = "folder-grid";
                pathText.innerText = "2026 > " + viewState.exam;
                titleText.innerText = "Select Subject Folder";
                backBtn.classList.remove('hidden');

                const subjects = [...new Set(allTests.filter(t => t.exam === viewState.exam).map(t => t.subject))];
                subjects.forEach(sub => createFolder(sub, "üìò", () => {
                    viewState.level = 'test'; viewState.subject = sub; renderUI();
                }));
            }
            else if (viewState.level === 'test') {
                contentArea.className = "test-grid";
                pathText.innerText = viewState.exam + " > " + viewState.subject;
                titleText.innerText = "Available Tests";
                backBtn.classList.remove('hidden');

                const tests = allTests.filter(t => t.exam === viewState.exam && t.subject === viewState.subject);
                tests.forEach(test => {
                    const isDone = userResults.has(test.id);
                    const card = `
                        <div class="test-card">
                            <div class="flex justify-between items-center mb-2">
                                <span class="bg-blue-100 text-blue-800 text-[10px] font-bold px-2 py-0.5 rounded uppercase">${test.chapter || 'Chapter'}</span>
                                <span class="text-[10px] text-gray-400">‚è±Ô∏è ${test.duration}m</span>
                            </div>
                            <h4 class="font-bold text-base text-slate-800 leading-tight">${test.title}</h4>
                            <div class="text-[10px] text-gray-500 mt-2 mb-3">
                                üìù ${test.questions.length} Qs ‚Ä¢ üéØ ${test.duration} Marks
                            </div>
                            <button onclick="startTest('${test.id}')" class="w-full ${isDone ? 'bg-green-600' : 'bg-blue-900'} text-white py-2 rounded-lg font-bold text-xs hover:bg-yellow-500 hover:text-black transition">
                                ${isDone ? 'Re-attempt Test' : 'Attempt Now'}
                            </button>
                        </div>`;
                    contentArea.innerHTML += card;
                });
            }
        }

        function createFolder(name, icon, clickFn) {
            const div = document.createElement('div');
            div.className = "folder-card";
            div.innerHTML = `<span class="folder-icon">${icon}</span><span class="font-bold text-gray-700 text-sm">${name}</span>`;
            div.onclick = clickFn;
            contentArea.appendChild(div);
        }

        backBtn.onclick = () => {
            if (viewState.level === 'test') viewState.level = 'subject';
            else if (viewState.level === 'subject') viewState.level = 'exam';
            renderUI();
        };

        window.startTest = (id) => {
            window.location.href = `test-player.html?id=${id}`;
        };

        document.getElementById('logout-btn').onclick = () => signOut(auth);
    </script>
</body>
</html>
