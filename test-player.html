<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Exam Player | Janz Education</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Poppins', sans-serif; background: #f8fafc; }
        .analysis-card { display: none; }
        .analysis-card.active { display: block; }
    </style>
</head>
<body>
    <div id="test-header" class="hidden sticky top-0 bg-white shadow-sm p-3 z-50 border-b border-slate-200">
        <div class="max-w-4xl mx-auto flex justify-between items-center">
            <h2 id="test-title-display" class="font-bold text-slate-800 text-[11px] uppercase truncate w-1/2">Loading...</h2>
            <div class="flex items-center gap-2">
                <div id="timer" class="bg-red-500 text-white px-3 py-1 rounded-full font-black text-[11px]">00:00</div>
                <button onclick="finishTest()" class="bg-blue-900 text-white px-3 py-1 rounded-lg text-[10px] font-bold">SUBMIT</button>
            </div>
        </div>
    </div>

    <div id="test-screen" class="hidden p-4 max-w-4xl mx-auto mt-2">
        <div class="bg-white p-5 rounded-3xl shadow-lg border border-slate-100">
            <span id="q-count" class="text-[9px] font-black text-blue-600 bg-blue-50 px-3 py-1 rounded-full uppercase tracking-tighter">Q1</span>
            <h3 id="q-text" class="mt-4 mb-6 text-sm font-bold text-slate-800 leading-relaxed">Loading Question...</h3>
            <div id="options-container" class="space-y-2.5"></div>
            <div class="flex justify-between mt-8 gap-3">
                <button id="prev-btn" onclick="prevQ()" class="flex-1 bg-slate-100 py-3 rounded-xl font-bold text-slate-500 hidden text-xs">PREVIOUS</button>
                <button id="next-btn" onclick="nextQ()" class="flex-1 bg-blue-900 text-white py-3 rounded-xl font-bold text-xs">NEXT QUESTION</button>
            </div>
        </div>
    </div>

    <div id="result-screen" class="hidden p-3 max-w-4xl mx-auto">
        <div class="bg-blue-900 text-white p-5 rounded-[2rem] text-center shadow-xl mb-6 border-b-4 border-yellow-400">
            <h1 class="text-xl font-black mb-1">TEST RESULT</h1>
            <div class="flex justify-around gap-3 mt-4">
                <div class="bg-white/10 p-3 rounded-2xl flex-1 border border-white/5">
                    <p class="text-[9px] opacity-60 uppercase mb-1">Score</p>
                    <h2 id="res-score" class="text-2xl font-black text-yellow-400">0/0</h2>
                </div>
                <div class="bg-white/10 p-3 rounded-2xl flex-1 border border-white/5">
                    <p class="text-[9px] opacity-60 uppercase mb-1">Accuracy</p>
                    <h2 id="res-acc" class="text-2xl font-black text-green-400">0%</h2>
                </div>
            </div>
            <div id="history-box" class="mt-4 text-left bg-black/20 p-3 rounded-xl hidden text-[10px]">
                <p class="font-bold text-yellow-400 mb-1 tracking-widest uppercase">History</p>
                <div id="history-list" class="space-y-1"></div>
            </div>
            <button onclick="goToHome()" class="mt-4 bg-white text-blue-900 px-6 py-2 rounded-lg font-black text-[10px] uppercase shadow-md">Back to Home</button>
        </div>

        <div class="flex justify-between items-center mb-3 px-2">
            <h3 class="font-black text-slate-800 uppercase text-xs">Analysis</h3>
            <span id="analysis-counter" class="bg-blue-600 text-white px-3 py-0.5 rounded-full text-[10px]">1/10</span>
        </div>
        <div id="analysis-list"></div>
        <div class="flex justify-between mt-5 gap-3 pb-10 px-2">
            <button id="prev-anal" onclick="moveAnalysis(-1)" class="flex-1 bg-white border border-slate-200 py-3 rounded-xl font-bold text-xs text-slate-600 shadow-sm">PREV</button>
            <button id="next-anal" onclick="moveAnalysis(1)" class="flex-1 bg-slate-800 text-white py-3 rounded-xl font-bold text-xs shadow-lg">NEXT</button>
        </div>
    </div>

    <script type="module">
        import { auth, db } from "./config.js";
        import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { collection, addDoc, doc, getDoc, getDocs, query, where, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        let testId = new URLSearchParams(window.location.search).get('id');
        // ðŸ”¥ à¤šà¥‡à¤• à¤•à¤° à¤°à¤¹à¥‡ à¤¹à¥ˆà¤‚ à¤•à¤¿ à¤›à¤¾à¤¤à¥à¤° 'History' à¤¬à¤Ÿà¤¨ à¤¦à¤¬à¤¾à¤•à¤° à¤†à¤¯à¤¾ à¤¹à¥ˆ à¤¯à¤¾ 'Attempt'
        let isHistoryView = new URLSearchParams(window.location.search).get('view') === 'history';
        
        let testData, currentQ = 0, currentAnal = 0, answers = {}, timeLeft, timerInterval, isSubmitting = false;

        // ðŸ”¥ à¤®à¥‡à¤¨ à¤«à¤¿à¤•à¥à¤¸: Firebase Auth à¤šà¥‡à¤• à¤•à¤°à¥‡à¤—à¤¾ à¤¤à¤­à¥€ à¤¡à¥‡à¤Ÿà¤¾ à¤¨à¤¿à¤•à¤¾à¤²à¥‡à¤—à¤¾, à¤œà¤¿à¤¸à¤¸à¥‡ à¤•à¥à¤°à¥ˆà¤¶ à¤¨à¤¹à¥€à¤‚ à¤¹à¥‹à¤—à¤¾
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                const snap = await getDoc(doc(db, "tests", testId));
                if(!snap.exists()) return alert("Test not found!");
                testData = snap.data();
                timeLeft = testData.questions.length * 60;
                document.getElementById('test-title-display').innerText = testData.title;

                // à¤¬à¥ˆà¤• à¤¬à¤Ÿà¤¨ à¤²à¥‰à¤•
                history.pushState(null, null, location.href);
                window.onpopstate = () => {
                    // à¤…à¤—à¤° à¤¹à¤¿à¤¸à¥à¤Ÿà¥à¤°à¥€ à¤¦à¥‡à¤– à¤°à¤¹à¤¾ à¤¹à¥ˆ à¤¤à¥‹ à¤•à¥‹à¤ˆ à¤šà¥‡à¤¤à¤¾à¤µà¤¨à¥€ à¤®à¤¤ à¤¦à¥‹
                    if(!isSubmitting && !isHistoryView) {
                        if(confirm("à¤¸à¤¾à¤µà¤§à¤¾à¤¨! à¤ªà¤¹à¤²à¥‡ à¤¸à¤¬à¤®à¤¿à¤Ÿ à¤•à¤°à¥‡à¤‚!")) window.location.href='dashboard.html';
                        else history.pushState(null, null, location.href);
                    } else {
                        window.location.href='dashboard.html';
                    }
                };

                // ðŸ”¥ à¤…à¤—à¤° à¤¹à¤¿à¤¸à¥à¤Ÿà¥à¤°à¥€ à¤¦à¥‡à¤–à¤¨à¥€ à¤¹à¥ˆ, à¤¤à¥‹ à¤Ÿà¥‡à¤¸à¥à¤Ÿ à¤¶à¥à¤°à¥‚ à¤®à¤¤ à¤•à¤°à¥‹! à¤¸à¥€à¤§à¤¾ à¤°à¤¿à¥›à¤²à¥à¤Ÿ à¤¦à¤¿à¤–à¤¾à¤“
                if (isHistoryView) {
                    document.getElementById('test-header').classList.add('hidden');
                    document.getElementById('test-screen').classList.add('hidden');
                    
                    // Firebase à¤¸à¥‡ à¤ªà¥à¤°à¤¾à¤¨à¥‡ à¤°à¤¿à¤œà¤²à¥à¤Ÿà¥à¤¸ à¤²à¤¾à¤“
                    const hSnap = await getDocs(query(collection(db, "results"), where("testId", "==", testId), where("userId", "==", user.uid), orderBy("timestamp", "desc")));
                    
                    if(!hSnap.empty) {
                        let latestResult = hSnap.docs[0].data(); // à¤¸à¤¬à¤¸à¥‡ à¤¤à¤¾à¥›à¤¾ à¤°à¤¿à¤œà¤²à¥à¤Ÿ
                        answers = latestResult.answers || {}; // ðŸ”¥ à¤ªà¥à¤°à¤¾à¤¨à¥€ à¤šà¥à¤¨à¥€ à¤¹à¥à¤ˆ answers à¤²à¥‹à¤¡ à¤•à¤°à¥‹
                        renderAnalysis(latestResult.score, latestResult.accuracy);
                        loadHistory(); 
                    } else {
                        alert("à¤•à¥‹à¤ˆ à¤ªà¥à¤°à¤¾à¤¨à¥€ à¤¹à¤¿à¤¸à¥à¤Ÿà¥à¤°à¥€ à¤¨à¤¹à¥€à¤‚ à¤®à¤¿à¤²à¥€!");
                        window.location.href = 'dashboard.html';
                    }
                } else {
                    // à¤…à¤—à¤° 'Attempt Now' à¤¯à¤¾ 'Re-attempt' à¤¸à¥‡ à¤†à¤¯à¤¾ à¤¹à¥ˆ, à¤¤à¥‹ à¤Ÿà¥‡à¤¸à¥à¤Ÿ à¤¶à¥à¤°à¥‚ à¤•à¤°à¥‹
                    startTest();
                }
            } else {
                window.location.href = "index.html";
            }
        });

        function startTest() {
            document.getElementById('test-header').classList.remove('hidden');
            document.getElementById('test-screen').classList.remove('hidden');
            showQuestion();
            startTimer();
        }

        function showQuestion() {
            const q = testData.questions[currentQ];
            document.getElementById('q-count').innerText = `Q${currentQ+1} of ${testData.questions.length}`;
            document.getElementById('q-text').innerText = q.question;
            const container = document.getElementById('options-container');
            container.innerHTML = "";
            q.options.forEach((opt, i) => {
                const sel = answers[currentQ] === i;
                container.innerHTML += `<div onclick="selectOpt(${i})" class="p-3 border-2 rounded-xl cursor-pointer flex items-center gap-3 ${sel?'border-blue-900 bg-blue-50':'border-slate-100 bg-white'}"><span class="w-7 h-7 flex items-center justify-center rounded-lg border font-black text-[10px] ${sel?'bg-blue-900 text-white':'bg-slate-50 text-slate-400'}">${String.fromCharCode(65+i)}</span><p class="text-[13px] font-bold ${sel?'text-blue-900':'text-slate-600'}">${opt}</p></div>`;
            });
            document.getElementById('prev-btn').style.display = currentQ > 0 ? 'block' : 'none';
            document.getElementById('next-btn').innerText = currentQ === testData.questions.length-1 ? "FINISH" : "NEXT";
        }

        window.selectOpt = (i) => { answers[currentQ] = i; showQuestion(); };
        window.nextQ = () => { if(currentQ < testData.questions.length-1){ currentQ++; showQuestion(); } else finishTest(); };
        window.prevQ = () => { if(currentQ > 0){ currentQ--; showQuestion(); } };

        function startTimer() {
            timerInterval = setInterval(() => {
                let m = Math.floor(timeLeft/60), s = timeLeft%60;
                document.getElementById('timer').innerText = `${m<10?'0'+m:m}:${s<10?'0'+s:s}`;
                if(timeLeft <= 0) finishTest();
                timeLeft--;
            }, 1000);
        }

        window.finishTest = async () => {
            if(isSubmitting) return;
            if(timeLeft > 0 && !confirm("à¤¸à¤¬à¤®à¤¿à¤Ÿ à¤•à¤°à¥‡à¤‚?")) return;
            isSubmitting = true; clearInterval(timerInterval);
            let score = 0;
            testData.questions.forEach((q, i) => { if(answers[i] === q.answer) score++; });
            let acc = Math.round((score / testData.questions.length) * 100);
            
            // à¤¤à¥à¤°à¤‚à¤¤ à¤à¤¨à¤¾à¤²à¤¿à¤¸à¤¿à¤¸ à¤¦à¤¿à¤–à¤¾à¤“
            renderAnalysis(score, acc);
            
            try {
                // ðŸ”¥ à¤¸à¤¬à¤¸à¥‡ à¤¬à¥œà¤¾ à¤¬à¤¦à¤²à¤¾à¤µ: à¤…à¤¬ à¤›à¤¾à¤¤à¥à¤° à¤•à¥€ à¤šà¥à¤¨à¥€ à¤¹à¥à¤ˆ 'answers' à¤­à¥€ Firebase à¤®à¥‡à¤‚ à¤¸à¥‡à¤µ à¤¹à¥‹à¤—à¥€!
                await addDoc(collection(db, "results"), { 
                    testId, 
                    userId: auth.currentUser.uid, 
                    score, 
                    accuracy: acc, 
                    answers: answers, // à¤›à¤¾à¤¤à¥à¤° à¤¨à¥‡ à¤•à¥à¤¯à¤¾ à¤šà¥à¤¨à¤¾ à¤¥à¤¾, à¤¯à¤¹ à¤­à¥€ à¤¸à¥‡à¤µ à¤•à¤° à¤°à¤¹à¥‡ à¤¹à¥ˆà¤‚
                    timestamp: serverTimestamp() 
                });
                loadHistory();
            } catch (e) { console.error("Error saving result:", e); }
        };

        async function loadHistory() {
            const hSnap = await getDocs(query(collection(db, "results"), where("testId", "==", testId), where("userId", "==", auth.currentUser.uid), orderBy("timestamp", "desc")));
            if(!hSnap.empty) {
                const hList = document.getElementById('history-list'); hList.innerHTML = "";
                hSnap.forEach(doc => {
                    const d = doc.data(); const date = d.timestamp ? d.timestamp.toDate().toLocaleDateString('hi-IN') : 'à¤…à¤­à¥€';
                    hList.innerHTML += `<div class="flex justify-between py-1 border-b border-white/5 text-[10px]"><span>ðŸ“… ${date}</span> <span>Score: ${d.score}/${testData.questions.length}</span></div>`;
                });
                document.getElementById('history-box').classList.remove('hidden');
            }
        }

        function renderAnalysis(score, acc) {
            document.getElementById('test-header').classList.add('hidden');
            document.getElementById('test-screen').classList.add('hidden');
            document.getElementById('res-score').innerText = `${score}/${testData.questions.length}`;
            document.getElementById('res-acc').innerText = `${acc}%`;
            
            const list = document.getElementById('analysis-list');
            list.innerHTML = "";
            testData.questions.forEach((q, i) => {
                const uAns = answers[i], cAns = q.answer, isCorrect = uAns === cAns;
                let optHtml = "";
                q.options.forEach((opt, idx) => {
                    let style = "border-slate-100 bg-white text-slate-400"; let label = "";
                    if(idx === cAns) { style = "border-green-500 bg-green-50 text-green-700 font-bold"; label = "âœ“ CORRECT"; }
                    else if(idx === uAns) { style = "border-red-500 bg-red-50 text-red-700 font-bold"; label = "âœ• WRONG"; }
                    optHtml += `<div class="p-3 border-2 rounded-xl mb-2 text-[11px] flex justify-between items-center ${style}"><span><b>${String.fromCharCode(65+idx)}.</b> ${opt}</span><span class="text-[8px] font-black uppercase">${label}</span></div>`;
                });
                list.innerHTML += `<div class="analysis-card bg-white p-5 rounded-[2rem] shadow-sm border-t-8 ${isCorrect?'border-green-500':'border-red-500'} ${i===0?'active':''}"><p class="text-[13px] font-bold text-slate-800 mb-4 leading-relaxed">${q.question}</p><div class="space-y-1">${optHtml}</div></div>`;
            });
            updateCounter();
            document.getElementById('result-screen').classList.remove('hidden');
            window.scrollTo(0,0);
        }

        window.moveAnalysis = (s) => {
            const cards = document.querySelectorAll('.analysis-card');
            cards[currentAnal].classList.remove('active');
            currentAnal = Math.max(0, Math.min(cards.length - 1, currentAnal + s));
            cards[currentAnal].classList.add('active');
            updateCounter();
        };

        function updateCounter() {
            document.getElementById('analysis-counter').innerText = `${currentAnal+1}/${testData.questions.length}`;
            document.getElementById('prev-anal').style.opacity = currentAnal === 0 ? "0.3" : "1";
            document.getElementById('next-anal').style.opacity = currentAnal === testData.questions.length-1 ? "0.3" : "1";
        }

        window.goToHome = () => { window.onbeforeunload = null; window.location.href = 'dashboard.html'; };
    </script>
</body>
</html>
