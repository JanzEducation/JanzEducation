<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Exam Player | Janz Education</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Poppins', sans-serif; background: #f1f5f9; }
        .opt-btn { transition: 0.2s; border: 2px solid #e2e8f0; }
        .selected { border-color: #1e3a8a !important; background: #eff6ff !important; }
        .correct { background: #dcfce7 !important; border-color: #22c55e !important; }
        .wrong { background: #fee2e2 !important; border-color: #ef4444 !important; }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <div id="intro-screen" class="fixed inset-0 bg-white z-[100] flex items-center justify-center p-6">
        <div class="max-w-md w-full text-center">
            <div class="text-6xl mb-4">üìù</div>
            <h1 id="intro-title" class="text-2xl font-bold text-slate-800 mb-2">Loading Test...</h1>
            <div class="bg-blue-50 p-4 rounded-xl text-left mb-6 text-sm text-slate-600 space-y-2">
                <p>‚Ä¢ <b>Total Questions:</b> <span id="intro-qs">0</span></p>
                <p>‚Ä¢ <b>Duration:</b> <span id="intro-time">0</span> Minutes</p>
                <p>‚Ä¢ <b>Marking:</b> +1 for Correct, 0 for Wrong</p>
                <p>‚Ä¢ Test submit ‡§π‡•ã‡§®‡•á ‡§ï‡•á ‡§¨‡§æ‡§¶ ‡§Ü‡§™ Analysis ‡§¶‡•á‡§ñ ‡§™‡§æ‡§è‡§Ç‡§ó‡•á‡•§</p>
            </div>
            <button id="start-btn" class="w-full bg-blue-900 text-white py-4 rounded-xl font-bold text-lg hover:bg-yellow-500 hover:text-black transition">START TEST NOW</button>
        </div>
    </div>

    <header class="bg-slate-900 text-white p-4 flex justify-between items-center sticky top-0 z-50">
        <button onclick="confirmExit()" class="text-xs font-bold bg-slate-800 px-3 py-1 rounded">‚úñ Exit</button>
        <div class="text-center">
            <p id="nav-title" class="text-[10px] text-blue-400 uppercase tracking-widest font-bold">Biology</p>
            <p id="nav-chapter" class="text-sm font-bold">Genetics Mock</p>
        </div>
        <div class="bg-red-600 px-3 py-1 rounded font-mono font-bold text-lg" id="timer">00:00</div>
    </header>

    <main id="test-main" class="flex-1 max-w-2xl w-full mx-auto p-4 hidden">
        <div class="bg-white p-6 rounded-2xl shadow-sm mb-6">
            <div class="flex justify-between items-center mb-4 text-xs font-bold text-slate-400">
                <span>QUESTION <span id="q-num">1</span> OF <span id="q-total">10</span></span>
            </div>
            <p id="q-text" class="text-lg font-bold text-slate-800 mb-6">Loading Question...</p>
            <div id="options" class="space-y-3"></div>
        </div>

        <div class="flex justify-between gap-4">
            <button id="prev-btn" class="flex-1 bg-slate-200 py-3 rounded-xl font-bold text-slate-600 disabled:opacity-30">Previous</button>
            <button id="next-btn" class="flex-1 bg-blue-900 py-3 rounded-xl font-bold text-white">Next</button>
            <button id="finish-btn" class="hidden flex-1 bg-green-600 py-3 rounded-xl font-bold text-white">Finish Test</button>
        </div>
    </main>

    <div id="result-screen" class="fixed inset-0 bg-slate-100 z-[200] hidden overflow-y-auto p-4">
        <div class="max-w-2xl mx-auto py-8">
            <div class="bg-white rounded-3xl p-8 text-center shadow-lg mb-6">
                <h2 class="text-2xl font-bold text-slate-800">Test Completed!</h2>
                <div class="flex justify-center gap-8 my-8">
                    <div><p class="text-4xl font-black text-blue-600" id="res-score">0</p><p class="text-xs font-bold text-slate-400">SCORE</p></div>
                    <div><p class="text-4xl font-black text-green-600" id="res-acc">0%</p><p class="text-xs font-bold text-slate-400">ACCURACY</p></div>
                </div>
                <button onclick="window.location.href='dashboard.html'" class="w-full bg-slate-900 text-white py-4 rounded-2xl font-bold">BACK TO DASHBOARD</button>
            </div>

            <h3 class="font-bold text-slate-800 mb-4">Question Analysis</h3>
            <div id="analysis-list" class="space-y-4"></div>
        </div>
    </div>

    <script type="module">
        import { auth, db } from "./config.js";
        import { doc, getDoc, addDoc, collection, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const params = new URLSearchParams(window.location.search);
        const testId = params.get('id');
        let testData, currentIdx = 0, answers = {}, timeLeft, timerInterval;

        async function init() {
            const snap = await getDoc(doc(db, "tests", testId));
            if (!snap.exists()) return window.location.href="dashboard.html";
            testData = snap.data();
            
            document.getElementById('intro-title').innerText = testData.title;
            document.getElementById('intro-qs').innerText = testData.questions.length;
            document.getElementById('intro-time').innerText = testData.duration;
            document.getElementById('nav-title').innerText = testData.subject;
            document.getElementById('nav-chapter').innerText = testData.title;
        }

        document.getElementById('start-btn').onclick = () => {
            document.getElementById('intro-screen').classList.add('hidden');
            document.getElementById('test-main').classList.remove('hidden');
            timeLeft = testData.duration * 60;
            startTimer();
            showQuestion(0);
        };

        function showQuestion(idx) {
            currentIdx = idx;
            const q = testData.questions[idx];
            document.getElementById('q-num').innerText = idx + 1;
            document.getElementById('q-total').innerText = testData.questions.length;
            document.getElementById('q-text').innerText = q.question;
            
            const optCont = document.getElementById('options');
            optCont.innerHTML = "";
            q.options.forEach((opt, i) => {
                const btn = document.createElement('button');
                btn.className = `opt-btn w-full text-left p-4 rounded-xl font-semibold flex items-center gap-4 ${answers[idx] === i ? 'selected' : 'bg-white'}`;
                btn.innerHTML = `<span class="w-8 h-8 rounded-full border flex items-center justify-center bg-slate-50 text-xs">${String.fromCharCode(65+i)}</span> ${opt}`;
                btn.onclick = () => { answers[idx] = i; showQuestion(idx); };
                optCont.appendChild(btn);
            });

            document.getElementById('prev-btn').disabled = idx === 0;
            const isLast = idx === testData.questions.length - 1;
            document.getElementById('next-btn').classList.toggle('hidden', isLast);
            document.getElementById('finish-btn').classList.toggle('hidden', !isLast);
        }

        document.getElementById('next-btn').onclick = () => showQuestion(currentIdx + 1);
        document.getElementById('prev-btn').onclick = () => showQuestion(currentIdx - 1);

        function startTimer() {
            timerInterval = setInterval(() => {
                const m = Math.floor(timeLeft / 60), s = timeLeft % 60;
                document.getElementById('timer').innerText = `${m}:${s < 10 ? '0'+s : s}`;
                if (timeLeft <= 0) finish();
                timeLeft--;
            }, 1000);
        }

        async function finish() {
            clearInterval(timerInterval);
            let correct = 0;
            testData.questions.forEach((q, i) => { if(answers[i] === q.answer) correct++; });

            const accuracy = Math.round((correct / testData.questions.length) * 100);
            
            // Save to Firebase
            await addDoc(collection(db, "results"), {
                testId, userId: auth.currentUser.uid, score: correct, accuracy, timestamp: serverTimestamp()
            });

            showResult(correct, accuracy);
        }

        function showResult(score, acc) {
            document.getElementById('res-score').innerText = score;
            document.getElementById('res-acc').innerText = acc + "%";
            
            const list = document.getElementById('analysis-list');
            testData.questions.forEach((q, i) => {
                const isCorrect = answers[i] === q.answer;
                list.innerHTML += `
                    <div class="bg-white p-4 rounded-xl border-l-4 ${isCorrect ? 'border-green-500' : 'border-red-500'}">
                        <p class="font-bold text-sm mb-2">Q${i+1}: ${q.question}</p>
                        <p class="text-xs ${isCorrect ? 'text-green-600' : 'text-red-600'}">Your: ${answers[i] !== undefined ? q.options[answers[i]] : 'Not Answered'}</p>
                        ${!isCorrect ? `<p class="text-xs text-green-600 font-bold">Correct: ${q.options[q.answer]}</p>` : ''}
                    </div>`;
            });
            document.getElementById('result-screen').classList.remove('hidden');
        }

        document.getElementById('finish-btn').onclick = () => { if(confirm("Finish Test?")) finish(); };
        window.confirmExit = () => { if(confirm("Pratice cancel karein? Progress save nahi hogi.")) window.location.href="dashboard.html"; };

        init();
    </script>
</body>
</html>
